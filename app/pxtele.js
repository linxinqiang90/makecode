const HID=require("node-hid"),SerialPort=require("serialport"),drivelist=require("drivelist"),path=require("path"),fs=require("fs-extra"),td=new TextDecoder;console.debug=console.log;const findeMicrobit=function(){return new Promise((e,t)=>{drivelist.list((i,s)=>{i&&t(i);let o=!1;for(const t of s)if("USB"===t.busType&&t.description.indexOf("MBED VFS")>-1){o=!0,e(t.mountpoints[0].path);break}o||t("no microbit found")})})};class pxtElectron{constructor(){this.versions={electronVersion:"123",chromiumVersion:"456",nodeVersion:"v8",pxtTargetVersion:"11122",pxtCoreVersion:"3.333",pxtElectronVersion:"2.1",isProd:0},this.sendUpdateStatusCheck=this.sendUpdateStatusCheck.bind(this),this.sendQuit=this.sendQuit.bind(this),this.sendOpenDevTools=this.sendOpenDevTools.bind(this),this.sendDriveDeploy=this.sendDriveDeploy.bind(this),this.configSerial=this.configSerial.bind(this),this.openSerial=this.openSerial.bind(this),this.closeSerial=this.closeSerial.bind(this),this.ser=null}openSerial(e){this.ser&&this.ser.isOpen||(this.ser=new SerialPort(e,{autoOpen:!1,baudRate:115200}),this.ser.open(e=>{e&&console.warn("serial open error")}),this.ser.on("data",t=>{this.onSerMsg(td.decode(t),e)}),this.ser.on("error",e=>{this.closeSerial()}),this.ser.on("close",e=>{this.closeSerial()}))}closeSerial(){this.ser=null}configSerial(e){this.onSerMsg=e;const t=this.openSerial;this.probeTimer=setInterval(()=>{SerialPort.list().then(e=>{for(let i of e)i.productId&&"0204"===i.productId&&t(i.comName)})},5e3)}onTelemetry(e){this.telemetry=e}onUpdateInstalled(e){this.updateInstalled=e}onUpdateStatus(e){this.updateStatus=e}onCriticalUpdateFailed(e){this.criticalUpdateFailed=e}onDriveDeployResult(e){this.onDriveDeployResult=e}sendUpdateStatusCheck(e){console.log("sendUpdateStatusCheck",e)}sendQuit(e){console.log("sendQuit",e)}sendOpenDevTools(e){console.log("sendOpenDevTools",e)}sendDriveDeploy(e){findeMicrobit().then(t=>{console.log("find microbit @",t);const i=e.outfiles["binary.hex"],s=path.resolve(t,e.downloadFileBaseName+".hex");fs.writeFileSync(s,i,"utf8"),this.onDriveDeployResult(!0)}).catch(e=>{this.onDriveDeployResult(!1)})}}window.pxtElectron=new pxtElectron;